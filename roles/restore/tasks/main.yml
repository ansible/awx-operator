---
- name: Patching labels to {{ kind }} kind
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: '{{ api_version }}'
      kind: '{{ kind }}'
      name: '{{ ansible_operator_meta.name }}'
      namespace: '{{ ansible_operator_meta.namespace }}'
      metadata:
        name: '{{ ansible_operator_meta.name }}'
        namespace: '{{ ansible_operator_meta.namespace }}'
        labels:
          app.kubernetes.io/name: '{{ ansible_operator_meta.name }}'
          app.kubernetes.io/part-of: '{{ ansible_operator_meta.name }}'
          app.kubernetes.io/managed-by: '{{ deployment_type }}-operator'
          app.kubernetes.io/component: '{{ deployment_type }}'
          app.kubernetes.io/operator-version: '{{ lookup("env", "OPERATOR_VERSION") }}'
  when: set_self_labels | bool

- name: Look up details for this restore object
  kubernetes.core.k8s_info:
    api_version: "{{ api_version }}"
    kind: "{{ kind }}"
    name: "{{ ansible_operator_meta.name }}"
    namespace: "{{ ansible_operator_meta.namespace }}"
  register: this_restore

- name: Run restore tasks
  block:
    - name: Include init tasks
      ansible.builtin.include_tasks: init.yml

    - name: Include import_vars tasks
      ansible.builtin.include_tasks: import_vars.yml

    - name: Include secrets tasks
      ansible.builtin.include_tasks: secrets.yml

    - name: Include deploy_awx tasks
      ansible.builtin.include_tasks: deploy_awx.yml

    - name: Include postgres tasks
      ansible.builtin.include_tasks: postgres.yml

    - name: Set flag signifying this restore was successful
      ansible.builtin.set_fact:
        tower_restore_complete: True

    - name: Include cleanup tasks
      ansible.builtin.include_tasks: cleanup.yml

  when:
    - this_restore['resources'][0]['status']['restoreComplete'] is not defined

- name: Update status variables
  ansible.builtin.include_tasks: update_status.yml
